<%= render 'spree/checkout/payment/v3/form_elements', payment_method: payment_method %>

<script src="/assets/frontend/stripe_init.js"></script>

<script>
  var cardNumber = initElements();

  cardNumber.addEventListener('change', function(event) {
    if (event.error) {
      Spree.stripePaymentMethod.errorElement.text(event.error.message).show();
    } else {
      Spree.stripePaymentMethod.errorElement.hide().text('');
    }
  });

  Spree.stripePaymentMethod.form.bind('submit', function(event) {
    if (Spree.stripePaymentMethod.element.is(':visible')) {
      event.preventDefault();

      Spree.Stripe.api.createToken(cardNumber).then(function(result) {
        if (result.error) {
          Spree.stripePaymentMethod.errorElement.text(result.error.message).show();
          setTimeout(function() {
            $.rails.enableElement(Spree.stripePaymentMethod.submitButton[0]);
            Spree.stripePaymentMethod.submitButton.removeAttr('disabled').removeClass('disabled');
          }, 100);
        } else {
          stripeTokenHandler(result.token);
          Spree.stripePaymentMethod.form[0].submit();
        }
      });
    }
  });
</script>
