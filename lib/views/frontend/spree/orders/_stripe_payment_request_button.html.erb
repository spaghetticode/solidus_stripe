<% if current_order.present? %>
  <% payment_method = Spree::PaymentMethod.last %>

  <div id="payment-request" style="clear:both; margin: 130px 0;">
    <%= form_tag update_checkout_path(:payment), method: :patch, id: "payment_method_#{payment_method.id}" do %>
      <%= hidden_field_tag "order[payments_attributes][][payment_method_id]", payment_method.id %>

      <div id="payment-request-button" data-stripe-config="<%= payment_method.stripe_config(current_order).to_json %>"></div>

      <div id="card-errors" class='errorExplanation' role="alert" style="display: none"></div>
    <% end %>
  </div>

  <script src="https://js.stripe.com/v3/"></script>
  <script src="/assets/frontend/stripe_init.js"></script>
  <script src="/assets/frontend/intents_init.js"></script>

  <script>
    Spree.stripePaymentMethod.config.payment_request.requestShipping = true;
    var paymentRequest = setUpPaymentRequest(Spree.stripePaymentMethod.config.payment_request);

    function handlePayment(result) {
      fetch('/stripe/shipping_address', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          shipping_address: result.shippingAddress,
          shipping_options: result.shippingOptions,
          authenticity_token: Spree.stripePaymentMethod.authToken
        })
      }).then(function(response) {
        response.json().then(function(json) {
          handleServerResponse(json, result);
        })
      });
    };

    function submitPayment(payment) {
      stripeTokenHandler(payment.paymentMethod);
      Spree.stripePaymentMethod.element.submit();
    }
  </script>
<% end %>
